<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Watch ads to unlock</title>
  <style>
    body { font-family: system-ui, Arial; padding: 2rem; max-width:640px; margin:auto; }
    .card { border:1px solid #eee; padding:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.03) }
    #counter { font-size:2rem; margin:1rem 0; }
    button { padding:.6rem 1rem; font-size:1rem; border-radius:8px; cursor:pointer }
    #status { margin-top:1rem; color:green }
  </style>
</head>
<body>
  <div class="card">
    <h1>Watch ads — get 24 hours free</h1>
    <div id="counter">0 / 10</div>
    <button id="watchBtn">Watch ad</button>
    <div id="status"></div>
    <p style="margin-top:1rem;color:#666">Note: watch 10 ads to get 24 hours free access.</p>
  </div>

<script>
const watchBtn = document.getElementById('watchBtn');
const counterEl = document.getElementById('counter');
const statusEl = document.getElementById('status');

async function fetchStatus() {
  const res = await fetch('/api/status', { credentials: 'include' });
  if (!res.ok) return;
  const j = await res.json();
  counterEl.textContent = `${j.views} / 10`;
  if (j.unlockedUntil) {
    statusEl.textContent = `Unlocked until ${new Date(j.unlockedUntil).toLocaleString()}`;
    watchBtn.disabled = true;
  } else {
    statusEl.textContent = '';
    watchBtn.disabled = false;
  }
}

async function notifyAdComplete(adProof) {
  // adProof: an object you might get from the ad SDK or your verification logic
  const res = await fetch('/api/ad-complete', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ proof: adProof })
  });
  const j = await res.json();
  if (res.ok) {
    counterEl.textContent = `${j.views} / 10`;
    if (j.unlockedUntil) {
      statusEl.textContent = `Unlocked until ${new Date(j.unlockedUntil).toLocaleString()}`;
      watchBtn.disabled = true;
    }
  } else {
    statusEl.textContent = j.message || 'Error';
  }
}

// Replace this function with real ad SDK flow.
// This simulates a 30s reward ad and then calls notifyAdComplete()
async function simulateAdAndNotify() {
  watchBtn.disabled = true;
  statusEl.textContent = 'Playing ad…';
  // simulate ad duration
  await new Promise(r => setTimeout(r, 3000)); // <-- change or use real SDK
  // after ad finishes, get "proof" from SDK (here simulated)
  const fakeProof = { provider: 'sim', watched: true, timestamp: Date.now() };
  await notifyAdComplete(fakeProof);
  watchBtn.disabled = false;
}

watchBtn.addEventListener('click', async () => {
  // In production: open ad in an iframe / call provider SDK; only call notifyAdComplete when provider verifies watch
  await simulateAdAndNotify();
});

// initial load
fetchStatus();
</script>
</body>
</html>
